#
# StartOS package build script
#
# Copyright 2012 StartOS
# Distributed under the terms of the GNU General Public License v2
#

DESCRIPTION="A functional language with OO extensions"
HOMEPAGE="http://caml.inria.fr/"
LICENSE="LGPL2,custom,QPL-1.0"
PACKAGER="Zhongxin Huang <huangzhongxin@ivali.com>"

SRC_URI="http://caml.inria.fr/distrib/"$N-${V%.?}"/"$N-$V".tar.gz"
CHECKSUM="91124a8eb12a57f1e56c02fe3db0f9e7"

RDEPEND="gdbm ncurses tk"
RECOMMENDED=""
BDEPEND="tk ncurses libx11"
OPTIONAL="ncurses: advanced ncurses features
          tk: advanced tk features"
CONFLICT=""

pbs_unpack() {
    dounpack
}

pbs_config() {
    ./configure --prefix /usr --libdir /usr/lib"$LIBDIRSUFFIX" --mandir /usr/share/man  
}

pbs_build() {
    make world.opt
}

pbs_install() {
    make PREFIX="${destdir}/usr" MANDIR="${destdir}/usr/share/man" install
    dodoc LICENSE
    
    # Install compiler libraries
    local compiler_libs="${destdir}/usr/lib"$LIBDIRSUFFIX"/ocaml/compiler-libs"
    mkdir -p "$compiler_libs"/{parsing,typing,utils}
    cp parsing/*.{cmi,cmo,cmx,ml,mli,mll,o} "$compiler_libs"/parsing
    cp typing/*.{cmi,cmo,cmx,ml,mli,o} "$compiler_libs"/typing
    cp utils/*.{cmi,cmo,cmx,ml,mli,o} "$compiler_libs"/utils
    
    # Duplicated by installation
    rm -f "$compiler_libs"/typing/outcometree.{cmi,mli}
}

